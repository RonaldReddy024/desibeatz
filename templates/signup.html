from flask import Flask, request, session, redirect, url_for, render_template_string
import sqlite3
import hashlib

app = Flask(__name__)
app.secret_key = 'your_super_secret_key'  # Replace this with a strong secret key

# Database connection helper
def get_db():
    conn = sqlite3.connect('database.db')
    conn.row_factory = sqlite3.Row
    return conn

# Initialize the database with a users table containing username, email, and hashed password
def init_db():
    db = get_db()
    db.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT UNIQUE NOT NULL,
            password_hash TEXT NOT NULL
        )
    ''')
    db.commit()

init_db()

# HTML template for the signup page (your provided code)
signup_template = '''
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up | DesiBeats</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: white;
    }
    .container {
      max-width: 400px;
      width: 100%;
      padding: 20px;
      background-color: #111;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%;
      padding: 15px;
      margin-bottom: 16px;
      border: none;
      border-radius: 25px;
      background-color: #333;
      color: white;
      font-size: 14px;
    }
    input::placeholder {
      color: #aaa;
    }
    button {
      background-color: #ff0050;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #e60045;
    }
    p {
      margin-top: 10px;
      font-size: 14px;
    }
    a {
      color: #ff0050;
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Sign Up</h1>
    <form method="POST" action="/signup">
      <input type="text" name="username" placeholder="Username" required>
      <input type="email" name="email" placeholder="Email" required>
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Sign Up</button>
    </form>
    <p>Already have an account? <a href="/login">Login here</a></p>
  </div>
</body>
</html>
'''

# HTML template for the login page
login_template = '''
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | DesiBeats</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: white;
    }
    .container {
      max-width: 400px;
      width: 100%;
      padding: 20px;
      background-color: #111;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      text-align: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 15px;
      margin-bottom: 16px;
      border: none;
      border-radius: 25px;
      background-color: #333;
      color: white;
      font-size: 14px;
    }
    input::placeholder {
      color: #aaa;
    }
    button {
      background-color: #ff0050;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #e60045;
    }
    p {
      margin-top: 10px;
      font-size: 14px;
    }
    a {
      color: #ff0050;
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Login</h1>
    <form method="POST" action="/login">
      <input type="text" name="username" placeholder="Username" required>
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <p>Don't have an account? <a href="/signup">Sign Up here</a></p>
  </div>
</body>
</html>
'''

@app.route('/signup', methods=['GET', 'POST'])
def signup():
    if request.method == 'POST':
        username = request.form.get('username')
        email = request.form.get('email')
        password = request.form.get('password')
        # Hash the password using SHA-256; for production, consider bcrypt or Argon2.
        password_hash = hashlib.sha256(password.encode()).hexdigest()
        
        try:
            db = get_db()
            db.execute('INSERT INTO users (username, email, password_hash) VALUES (?, ?, ?)', 
                       (username, email, password_hash))
            db.commit()
            return 'User registered successfully! <a href="/login">Login here</a>'
        except sqlite3.IntegrityError as e:
            # Catches duplicate username or email errors.
            return f'Error: {str(e)}'
    return render_template_string(signup_template)

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        password_hash = hashlib.sha256(password.encode()).hexdigest()
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE username = ? AND password_hash = ?', 
                          (username, password_hash)).fetchone()
        if user:
            session['user_id'] = user['id']
            return 'Logged in successfully! <a href="/dashboard">Go to Dashboard</a>'
        else:
            return 'Invalid credentials, please try again.'
    return render_template_string(login_template)

@app.route('/dashboard')
def dashboard():
    if 'user_id' in session:
        return 'Welcome to your dashboard! <a href="/logout">Logout</a>'
    return redirect(url_for('login'))

@app.route('/logout')
def logout():
    session.pop('user_id', None)
    return redirect(url_for('login'))

if __name__ == '__main__':
    app.run(debug=True)
